<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16:9 å›¾ç‰‡å¹¿å‘Šæ°´å°å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            margin-bottom: 20px;
            position: relative;
        }

        .upload-area:hover {
            border-color: #1890ff;
            background-color: #f9f9f9;
        }

        .upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
            margin-top: 8px;
        }

        #preview-container {
            margin-top: 20px;
            display: none;
            width: 100%;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            display: none;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background-color: #40a9ff;
        }

        .error-msg {
            color: #ff4d4f;
            margin-top: 10px;
            display: none;
            font-weight: 500;
        }

        .dev-options {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            text-align: left;
            display: none; /* Initially hidden until image loaded, or always visible? Better hidden until needed */
        }
        
        .dev-options.visible {
            display: block;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            padding-bottom: 20px;
        }
        
        .footer a {
            color: #666;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .footer a:hover {
            color: #333;
        }

        .dev-options h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .control-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .control-group label {
            width: 100px;
            font-size: 14px;
            color: #666;
        }
        
        .control-group input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        
        .control-group input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>BiliCover å¹¿å‘Šæ°´å°å·¥å…·</h1>
        
        <div class="upload-area" id="drop-zone">
            <input type="file" id="file-input" accept="image/png, image/jpeg, image/jpg">
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-hint">ä»…æ”¯æŒ 16:9 æ¯”ä¾‹çš„å›¾ç‰‡</div>
        </div>

        <div id="error-msg" class="error-msg"></div>
        
        <div id="dev-options" class="dev-options">
            <h3 id="dev-options-toggle">ğŸ›  å¼€å‘é€‰é¡¹ (ç‚¹å‡»æ”¶èµ·/å±•å¼€)</h3>
            <div id="dev-controls">
                <div class="control-group">
                    <label>ç¼©æ”¾æ¯”ä¾‹</label>
                    <input type="range" id="scale-range" min="0.5" max="5.0" step="0.1" value="3.9">
                    <input type="number" id="scale-num" min="0.5" max="5.0" step="0.1" value="3.9">
                </div>
                <div class="control-group">
                    <label>å³è¾¹è·</label>
                    <input type="range" id="margin-x-range" min="0" max="100" step="1" value="69">
                    <input type="number" id="margin-x-num" min="0" max="200" step="1" value="69">
                </div>
                <div class="control-group">
                    <label>ä¸‹è¾¹è·</label>
                    <input type="range" id="margin-y-range" min="0" max="100" step="1" value="65">
                    <input type="number" id="margin-y-num" min="0" max="200" step="1" value="65">
                </div>
                <div class="control-group">
                    <label>æ°´å°é€æ˜åº¦</label>
                    <input type="range" id="opacity-range" min="0.1" max="1.0" step="0.1" value="1.0">
                    <input type="number" id="opacity-num" min="0.1" max="1.0" step="0.1" value="1.0">
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <div class="control-group">
                    <label style="width: auto; margin-right: 10px;">å¯ç”¨å¯¹ç…§ç»„</label>
                    <input type="checkbox" id="ref-toggle">
                </div>
                <div class="control-group" id="main-opacity-group" style="display: none;">
                    <label>ä¸»å›¾é€æ˜åº¦</label>
                    <input type="range" id="main-opacity-range" min="0.0" max="1.0" step="0.1" value="1.0">
                    <input type="number" id="main-opacity-num" min="0.0" max="1.0" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <div id="preview-container">
            <canvas id="canvas"></canvas>
            <br>
            <a id="download-btn" class="btn hidden" download="processed_image.png">ä¸‹è½½å›¾ç‰‡</a>
        </div>
    </div>

    <div class="footer">
        <a href="https://github.com/afoim/bilicover_ad_add" target="_blank">
            <svg height="20" viewBox="0 0 16 16" version="1.1" width="20" aria-hidden="true" style="fill: currentColor; margin-right: 6px;">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
            afoim/bilicover_ad_add
        </a>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const errorMsg = document.getElementById('error-msg');
        const previewContainer = document.getElementById('preview-container');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const downloadBtn = document.getElementById('download-btn');
        
        // Dev options controls
        const devOptions = document.getElementById('dev-options');
        const devOptionsToggle = document.getElementById('dev-options-toggle');
        const devControls = document.getElementById('dev-controls');
        
        const scaleRange = document.getElementById('scale-range');
        const scaleNum = document.getElementById('scale-num');
        const marginXRange = document.getElementById('margin-x-range');
        const marginXNum = document.getElementById('margin-x-num');
        const marginYRange = document.getElementById('margin-y-range');
        const marginYNum = document.getElementById('margin-y-num');
        const opacityRange = document.getElementById('opacity-range');
        const opacityNum = document.getElementById('opacity-num');
        
        const refToggle = document.getElementById('ref-toggle');
        const mainOpacityGroup = document.getElementById('main-opacity-group');
        const mainOpacityRange = document.getElementById('main-opacity-range');
        const mainOpacityNum = document.getElementById('main-opacity-num');

        // State
        let currentImg = null;
        let currentWatermark = null;
        let refImg = null;

        // Sync inputs
        function linkInputs(range, num) {
            range.addEventListener('input', () => {
                num.value = range.value;
                redraw();
            });
            num.addEventListener('input', () => {
                range.value = num.value;
                redraw();
            });
        }

        linkInputs(scaleRange, scaleNum);
        linkInputs(marginXRange, marginXNum);
        linkInputs(marginYRange, marginYNum);
        linkInputs(opacityRange, opacityNum);
        linkInputs(mainOpacityRange, mainOpacityNum);
        
        refToggle.addEventListener('change', () => {
            if (refToggle.checked) {
                mainOpacityGroup.style.display = 'flex';
                if (!refImg) {
                    loadRefImage();
                } else {
                    redraw();
                }
            } else {
                mainOpacityGroup.style.display = 'none';
                redraw();
            }
        });

        devOptionsToggle.addEventListener('click', () => {
            if (devControls.style.display === 'none') {
                devControls.style.display = 'block';
            } else {
                devControls.style.display = 'none';
            }
        });

        function loadRefImage() {
            const img = new Image();
            img.onload = function() {
                refImg = img;
                redraw();
            };
            img.onerror = function() {
                alert('æ— æ³•åŠ è½½å¯¹ç…§å›¾ ad_than.pngï¼Œè¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨');
                refToggle.checked = false;
                mainOpacityGroup.style.display = 'none';
            };
            img.src = './ad_than.png';
        }

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ‹½æ”¯æŒ
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#1890ff';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ddd';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ddd';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            // é‡ç½®çŠ¶æ€
            errorMsg.style.display = 'none';
            previewContainer.style.display = 'none';
            downloadBtn.classList.add('hidden');
            devOptions.classList.remove('visible'); // éšè—å¼€å‘é€‰é¡¹ç›´åˆ°åŠ è½½æˆåŠŸ

            if (!file.type.startsWith('image/')) {
                showError('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImg = img; // ä¿å­˜å›¾ç‰‡å¯¹è±¡
                    processImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
        }

        function processImage(img) {
            const width = img.width;
            const height = img.height;
            const ratio = width / height;
            const targetRatio = 16 / 9;
            const epsilon = 0.01; // å…è®¸çš„è¯¯å·®èŒƒå›´

            if (Math.abs(ratio - targetRatio) > epsilon) {
                showError(`å›¾ç‰‡æ¯”ä¾‹ä¸ç¬¦åˆ 16:9 (å½“å‰æ¯”ä¾‹: ${ratio.toFixed(2)})`);
                return;
            }

            // å¦‚æœå·²ç»åŠ è½½è¿‡æ°´å°ï¼Œç›´æ¥é‡ç»˜
            if (currentWatermark) {
                redraw();
                devOptions.classList.add('visible');
                return;
            }

            // åŠ è½½æ°´å°å›¾ç‰‡
            const watermarkImg = new Image();
            watermarkImg.onload = function() {
                currentWatermark = watermarkImg; // ä¿å­˜æ°´å°å¯¹è±¡
                redraw();
                devOptions.classList.add('visible');
            };
            watermarkImg.onerror = function() {
                showError('æ— æ³•åŠ è½½æ°´å°å›¾ç‰‡ ad.pngï¼Œè¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨');
            };
            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½ï¼Œå‡è®¾ ad.png ä¸ index.html åœ¨åŒä¸€ç›®å½•
            watermarkImg.src = './ad.png';
        }
        
        function redraw() {
            if (!currentImg || !currentWatermark) return;
            
            const width = currentImg.width;
            const height = currentImg.height;
            
            // è®¾ç½® Canvas å°ºå¯¸
            canvas.width = width;
            canvas.height = height;

            // 1. ç»˜åˆ¶å¯¹ç…§å›¾ï¼ˆå¦‚æœåœ¨åº•å±‚ä¸”å¯ç”¨ï¼‰
            if (refToggle.checked && refImg) {
                // ä¿æŒæ¯”ä¾‹é“ºæ»¡æˆ–é€‚åº”ï¼Ÿå‡è®¾ä¹Ÿæ˜¯ 16:9ï¼Œç›´æ¥æ‹‰ä¼¸åŒ¹é…ç”»å¸ƒ
                ctx.drawImage(refImg, 0, 0, width, height);
            }

            // 2. ç»˜åˆ¶ç”¨æˆ·ä¸»å›¾
            // å¦‚æœå¼€å¯äº†å¯¹ç…§ç»„ï¼Œåº”ç”¨ä¸»å›¾é€æ˜åº¦ï¼›å¦åˆ™ä¸é€æ˜
            if (refToggle.checked) {
                const mainAlpha = parseFloat(mainOpacityNum.value);
                ctx.globalAlpha = isNaN(mainAlpha) ? 1.0 : mainAlpha;
            }
            ctx.drawImage(currentImg, 0, 0);
            ctx.globalAlpha = 1.0; // æ¢å¤
            
            // 3. ç»˜åˆ¶æ°´å°
            drawWatermark(currentWatermark, width, height);
            
            // æ˜¾ç¤ºç»“æœ
            previewContainer.style.display = 'block';
            
            // è®¾ç½®ä¸‹è½½é“¾æ¥
            // ä¸‹è½½æ—¶éœ€è¦é‡æ–°ç»˜åˆ¶ä¸€ä¸ªä¸å¸¦å¯¹ç…§ç»„ã€ä¸é€æ˜çš„ç‰ˆæœ¬å—ï¼Ÿ
            // é€šå¸¸ç”¨æˆ·åªæ˜¯æƒ³ç”¨å¯¹ç…§ç»„æ¥å¯¹é½ï¼Œä¸‹è½½æ—¶è‚¯å®šä¸å¸Œæœ›åŒ…å«å¯¹ç…§ç»„æˆ–è€…åŠé€æ˜
            // æ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ canvas æˆ–è€…åœ¨å½“å‰ canvas å¿«é€Ÿé‡ç»˜ä¸€æ¬¡ï¼ˆä¸å¯è§ï¼‰æ¥ç”Ÿæˆæ•°æ® URLï¼Ÿ
            // æˆ–è€…æ›´ç®€å•ï¼šåœ¨ç‚¹å‡»ä¸‹è½½æ—¶åŠ¨æ€ç”Ÿæˆã€‚
            
            // å®é™…ä¸Šï¼Œç›´æ¥æ›´æ–° href ä¼šå¯¼è‡´ç”¨æˆ·ä¸‹è½½åˆ°é¢„è§ˆå›¾ï¼ˆå¯èƒ½åŒ…å«å¯¹ç…§ç»„ï¼‰ã€‚
            // è¿™æ˜¯ä¸€ä¸ªæ½œåœ¨é—®é¢˜ã€‚
            // æ›´å¥½çš„åšæ³•æ˜¯ï¼šæ¯æ¬¡é‡ç»˜æ—¶ï¼Œä¹Ÿç”Ÿæˆä¸€ä¸ªâ€œçº¯å‡€ç‰ˆâ€çš„ dataURL ç»™ä¸‹è½½æŒ‰é’®ã€‚
            // ä½†è¿™æ ·ä¼šæ¶ˆè€—æ€§èƒ½ã€‚
            // æ—¢ç„¶æ˜¯å·¥å…·ï¼Œç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å†ç”Ÿæˆæ¯”è¾ƒå¥½ã€‚
            // æˆ‘ä»¬ä¿®æ”¹ downloadBtn çš„ç‚¹å‡»äº‹ä»¶ã€‚
            
            // è¿™é‡Œå…ˆæš‚æ—¶æ¸…ç©º hrefï¼Œå¼ºè¿«ç‚¹å‡»æ—¶ç”Ÿæˆ
            downloadBtn.onclick = function() {
                // åˆ›å»ºä¸´æ—¶ Canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // ç»˜åˆ¶ä¸»å›¾ (ä¸é€æ˜)
                tempCtx.drawImage(currentImg, 0, 0);
                
                // ç»˜åˆ¶æ°´å° (å¸¦ç”¨æˆ·è®¾ç½®çš„å‚æ•°)
                // éœ€è¦å¤ç”¨ drawWatermark çš„é€»è¾‘ï¼Œä½†è¦åœ¨ tempCtx ä¸Šç”»
                // æˆ‘ä»¬å¯ä»¥é‡æ„ drawWatermark æ¥å— ctx å‚æ•°
                drawWatermarkOnContext(tempCtx, currentWatermark, width, height);
                
                // ä¸‹è½½
                const dataURL = tempCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'processed_image.png';
                link.href = dataURL;
                link.click();
                return false; // é˜»æ­¢é»˜è®¤è·³è½¬
            };
            
            downloadBtn.removeAttribute('href'); // ç§»é™¤ç›´æ¥é“¾æ¥
            downloadBtn.classList.remove('hidden');
        }

        function drawWatermark(watermarkImg, canvasWidth, canvasHeight) {
            drawWatermarkOnContext(ctx, watermarkImg, canvasWidth, canvasHeight);
        }

        function drawWatermarkOnContext(context, watermarkImg, canvasWidth, canvasHeight) {
            // è·å–å‚æ•°
            const scaleUser = parseFloat(scaleNum.value) || 3.9;
            const marginXUser = parseFloat(marginXNum.value) || 69;
            const marginYUser = parseFloat(marginYNum.value) || 65;
            const opacityUser = parseFloat(opacityNum.value) || 1.0;

            // æ°´å°å‚æ•°è®¡ç®—
            const scaleFactor = canvasHeight / 1080;
            const wmRatio = watermarkImg.width / watermarkImg.height;
            
            // ç›®æ ‡é«˜åº¦ï¼šæ ¹æ® 1080p ä¸‹çº¦ 60px çš„é«˜åº¦è¿›è¡Œç¼©æ”¾ï¼Œå†ä¹˜ä»¥ç”¨æˆ·è®¾å®šçš„æ¯”ä¾‹
            const targetHeight = 60 * scaleFactor * scaleUser;
            const targetWidth = targetHeight * wmRatio;

            // è¾¹è·ä¹Ÿéœ€è¦æ ¹æ®åˆ†è¾¨ç‡ç¼©æ”¾
            const marginRight = marginXUser * scaleFactor;
            const marginBottom = marginYUser * scaleFactor;

            // è®¡ç®—ä½ç½® (å³ä¸‹è§’)
            const x = canvasWidth - targetWidth - marginRight;
            const y = canvasHeight - targetHeight - marginBottom;

            // ç»˜åˆ¶æ°´å°å›¾ç‰‡
            context.globalAlpha = opacityUser;
            context.drawImage(watermarkImg, x, y, targetWidth, targetHeight);
            context.globalAlpha = 1.0; // æ¢å¤é€æ˜åº¦
        }
    </script>
</body>
</html>
